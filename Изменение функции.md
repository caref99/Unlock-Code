import json
import os
from datetime import datetime

class PasswordManager:
    def __init__(self, storage_file="passwords.json"):
        self.storage_file = storage_file
        self.passwords = self.load_passwords()
    
    def load_passwords(self):
        if os.path.exists(self.storage_file):
            try:
                with open(self.storage_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except:
                return {}
        return {}
    
    def save_password(self, service, login, password, notes=""):
        try:
            self.passwords[service] = {
                'login': login,
                'password': password,
                'notes': notes,
                'created': datetime.now().isoformat(),
                'strength': self._calculate_strength(password)
            }
            self._save_to_file()
            return True
        except:
            return False
    
    def get_password(self, service):
        return self.passwords.get(service)
    
    def list_services(self):
        return list(self.passwords.keys())
    
    def _calculate_strength(self, password):
        score = 0
        if len(password) >= 12: score += 2
        elif len(password) >= 8: score += 1
        if any(c in "abcdefghijklmnopqrstuvwxyz" for c in password): score += 1
        if any(c in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" for c in password): score += 1
        if any(c in "0123456789" for c in password): score += 1
        if any(c in "!@#$%^&*()_+-=[]{}|;:,.<>?" for c in password): score += 1
        strength_levels = ["Очень слабый", "Слабый", "Средний", "Хороший", "Отличный", "Идеальный"]
        return strength_levels[min(score, 5)]
    
    def _save_to_file(self):
        try:
            with open(self.storage_file, 'w', encoding='utf-8') as f:
                json.dump(self.passwords, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"❌ Ошибка сохранения: {e}")

class PasswordManager:
    def __init__(self, storage_file="passwords_secure.json"):
        self.storage_file = storage_file
        self.passwords = self.load_passwords()

    def load_passwords(self):
        if os.path.exists(self.storage_file):
            try:
                with open(self.storage_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except:
                return {}
        return {}

    def save_password(self, service, login, password, notes=""):
        try:
            self.passwords[service] = {
                'login': login,
                'password': password,
                'notes': notes,
                'created': datetime.datetime.now().isoformat(),
                'strength': self._calculate_strength(password),
                'last_used': datetime.datetime.now().isoformat()
            }
            self._save_to_file()
            return True
        except Exception as e:
            return False

    def get_password(self, service):
        if service in self.passwords:
            self.passwords[service]['last_used'] = datetime.datetime.now().isoformat()
            self._save_to_file()
        return self.passwords.get(service)

    def list_services(self):
        return sorted(self.passwords.keys())

    def _calculate_strength(self, password):
        score = 0
        if len(password) >= 12: score += 2
        elif len(password) >= 8: score += 1
        if any(c in string.ascii_lowercase for c in password): score += 1
        if any(c in string.ascii_uppercase for c in password): score += 1
        if any(c in string.digits for c in password): score += 1
        if any(c in "!@#$%^&*()_+-=[]{}|;:,.<>?" for c in password): score += 1
        return min(score, 5)

    def _save_to_file(self):
        try:
            with open(self.storage_file, 'w', encoding='utf-8') as f:
                json.dump(self.passwords, f, ensure_ascii=False, indent=2)
        except:
            pass
